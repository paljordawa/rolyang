---
import { ViewTransitions } from 'astro:transitions';
import Player from '../components/Player.jsx';
import albums from '../data/data.json';
import "../styles.css"
const { hideNav, backHref, playerStart, hidePlayerUntilPlaying } = Astro.props;
---

<html lang="en" class="antialiased">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/src/styles.css" />
    <ViewTransitions />
    <!-- client-only module for navigation and player helpers -->
    <script is:inline>
      {`// Client helpers for SPA-like navigation and global player control
// - appNavigate(href): fetches page and swaps <main> content
// - playerPlay(payload): dispatches player:play

window.playerPlay = function (payload) {
  try { window.dispatchEvent(new CustomEvent('player:play', { detail: payload })); } catch (e) { }
};

async function appNavigate(href) {
  try {
    const res = await fetch(href, { cache: 'no-store' });
    if (!res.ok) { location.href = href; return; }
    const html = await res.text();
    const tmp = document.createElement('div'); tmp.innerHTML = html;
    const newMain = tmp.querySelector('main');
    if (!newMain) { location.href = href; return; }
    const curMain = document.querySelector('main');
    if (!curMain) { location.href = href; return; }
    // Replace contents
    curMain.innerHTML = newMain.innerHTML;

    // Execute scripts from the fetched main (inline and external)
    newMain.querySelectorAll('script').forEach((s) => {
      const next = document.createElement('script');
      if (s.src) next.src = s.src;
      if (s.type) next.type = s.type;
      if (s.textContent) next.textContent = s.textContent;
      document.head.appendChild(next);
      // remove after executed
      setTimeout(() => next.remove(), 1000);
    });

    // update title if present
    const titleEl = tmp.querySelector('title'); if (titleEl) document.title = titleEl.innerText;
    history.pushState({}, '', href);
    window.dispatchEvent(new Event('app:navigation'));
  } catch (e) {
    location.href = href;
  }
}

// link delegation for internal navigation
document.addEventListener('click', async (ev) => {
  if (ev.defaultPrevented) return;
  const anyEv = ev;
  let el = anyEv.target;
  while (el && el.nodeName !== 'A') el = el.parentElement;
  if (!el || el.nodeName !== 'A') return;
  const href = el.getAttribute && el.getAttribute('href');
  if (!href || (href.startsWith('http') && !href.startsWith(location.origin))) return; // external
  if ((el.hasAttribute && el.hasAttribute('data-no-route')) || el.target === '_blank') return;
  ev.preventDefault();
  appNavigate(href);
});

// popstate -> navigate
window.addEventListener('popstate', (e) => {
  const href = location.pathname + location.search + location.hash;
  appNavigate(href);
});

// delegation for player actions using data attributes
document.addEventListener('click', (ev) => {
  const anyEv = ev;
  const el = anyEv.target && anyEv.target.closest ? (anyEv.target.closest('[data-player-album]') || anyEv.target.closest('[data-player-book]')) : null;
  if (!el) return;
  ev.preventDefault();
  const albumId = el.dataset.playerAlbum || el.dataset.playerBook;
  const chapIndex = el.dataset.playerChap ? Number(el.dataset.playerChap) : 0;
  const expand = el.dataset.playerExpand !== 'false';
  const payload = { bookId: albumId, chapIndex, play: true, expand };
  // Dispatch the event and let the React player handle playback. Do not attempt
  // to force synchronous playback here — that logic was reverted per project
  // preference to keep the player island handling play behavior.
  window.playerPlay(payload);
});

// simple share button handling
document.addEventListener('click', (ev) => {
  const anyEv = ev;
  const el = anyEv.target && anyEv.target.closest ? anyEv.target.closest('[data-share-button]') : null;
  if (!el) return;
  ev.preventDefault();
  const share = { title: document.title, url: location.href };
  if (navigator.share) navigator.share(share).catch(() => {});
  else navigator.clipboard?.writeText(share.title + ' — ' + share.url);
});

// Re-dispatch app:navigation on initial load so components relying on it can init
window.dispatchEvent(new Event('app:init'));`}
    </script>
  </head>
  <body class="bg-slate-600 text-white min-h-screen">
    <div class="min-h-screen flex flex-col">
      <header class="fixed top-0 left-0 right-0 z-40">
        <div class="p-4 h-16 flex items-center justify-between max-w-4xl mx-auto w-full d">
          { backHref ? (
            <a href={backHref} class="p-2 rounded-md  inline-flex items-center gap-2" aria-label="Back">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              <span class="sr-only">Back</span>
            </a>
            
          ) : (
            <a href="/" class="font-bold text-xl">Rolyang</a>
          )}
          <nav class="hidden md:flex gap-4 items-center">
            <a href="/" class="opacity-90 hover:opacity-100">Home</a>
            <a href="/search" class="opacity-90 hover:opacity-100">Search</a>
            <!-- <a href="/library" class="opacity-90 hover:opacity-100">Library</a> -->
          </nav>
          <button
            data-share-button
            class="p-2 rounded-md inline-flex items-center ml-3"
            aria-label="Share"
            title="Share"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
            </svg>

          </button>
        </div>
      </header>
      <main class="flex-1 w-full max-w-4xl mx-auto  px-4 pt-16">
        <slot />
      </main>
      <!-- Listen for the Player fullscreen/expanded state so we can hide page titles -->
      <script>
        (function(){
          function update(expanded){
            document.querySelectorAll('.page-title').forEach(function(el){
              if (expanded) el.classList.add('hidden'); else el.classList.remove('hidden');
            });
            // hide main header and mobile footer while player is fully expanded
            var hdr = document.querySelector('header'); if (hdr) { if (expanded) hdr.classList.add('hidden'); else hdr.classList.remove('hidden'); }
            var ftr = document.querySelector('footer'); if (ftr) { if (expanded) ftr.classList.add('hidden'); else ftr.classList.remove('hidden'); }
          }
          try { update(localStorage.getItem('player:expanded') === 'true'); } catch(e){}
          // @ts-ignore -- custom event with detail object
          window.addEventListener('player:expanded', function(ev){ try { update(ev && ev.detail && ev.detail.expanded === true); } catch(e){} });
        })();
      </script>
      { !hideNav ? (
        <footer class="bg-white/6 dark:bg-black/40 text-white p-3 fixed bottom-4 left-4 right-4 rounded-3xl backdrop-blur-md shadow-lg md:hidden">
          <div class="flex justify-around">
            <a href="/" class="flex flex-col items-center text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            <span>Home</span></a>
            <a href="#" class="flex flex-col items-center text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 13v-1a8 8 0 0116 0v1m-3 3h1a2 2 0 002-2v-3a9 9 0 10-18 0v3a2 2 0 002 2h1" />
              </svg>
              <span>Now</span>
            </a>
            <a href="/search" class="flex flex-col items-center text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
              </svg>

            <span>Search</span></a>
          </div>
        </footer>
      ) : '' }

      <!-- Persistent bottom player island - always mounted so audio keeps playing across navigation -->
      <div
        class="fixed left-0 right-0 bottom-6 z-50 pointer-events-none md:bottom-8 transition-all duration-300"
        data-player-shell
        data-hidden={hidePlayerUntilPlaying ? 'true' : 'false'}
      >
        <div class="max-w-4xl mx-auto px-4">
          <div class="pointer-events-auto">
            <!-- hydrate the Player island on the client when it loads -->
            <Player client:load books={(albums as any)} startBookId={playerStart?.startBookId} startChapIndex={playerStart?.startChapIndex} />
          </div>
        </div>
      </div>
      {hidePlayerUntilPlaying ? (
        <>
          <style>
            {`[data-player-shell][data-hidden="true"]{opacity:0;pointer-events:none;transform:translateY(24px);}`}
          </style>
          <script>
            {`(() => {
  function reveal() {
    const shell = document.querySelector('[data-player-shell]');
    if (!shell) return;
    if (shell.dataset.hidden !== 'false') shell.dataset.hidden = 'false';
  }
  window.addEventListener('player:now-playing', (ev) => {
    if (ev && ev.detail && ev.detail.isPlaying !== false) reveal();
  });
  window.addEventListener('player:play', () => reveal());
  try {
    if (window.__playerNowPlaying && window.__playerNowPlaying.isPlaying !== false) reveal();
  } catch (e) {}
})();`}
          </script>
        </>
      ) : null}
    </div>
  </body>
</html>
